<!DOCTYPE html>
<html lang="en">
<head>
   <!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2PXG6EEVC0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-2PXG6EEVC0');

  // ============================================
  // IMPROVED TRACKING: Session & UTM Capture
  // ============================================
  const IV_SESSION = sessionStorage.getItem('iv_sid') || (() => {
      const id = 's_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
      sessionStorage.setItem('iv_sid', id);
      return id;
  })();

  const IV_UTM = (() => {
      const p = new URLSearchParams(window.location.search);
      if (p.get('utm_source')) {
          const d = { 
              source: p.get('utm_source') || 'direct', 
              medium: p.get('utm_medium') || 'none', 
              campaign: p.get('utm_campaign') || 'none',
              content: p.get('utm_content') || '',
              term: p.get('utm_term') || '',
              landing: window.location.pathname,
              landed: new Date().toISOString()
          };
          sessionStorage.setItem('iv_utm', JSON.stringify(d));
          return d;
      }
      const stored = sessionStorage.getItem('iv_utm');
      return stored ? JSON.parse(stored) : { source: 'direct', medium: 'none', campaign: 'none' };
  })();

  const IV_DEVICE = /iPhone|iPad|iPod/.test(navigator.userAgent) ? 'ios' : 
                    /Android/.test(navigator.userAgent) ? 'android' : 'desktop';

  // Track page land immediately
  gtag('event', 'page_land', { 
      session_id: IV_SESSION,
      traffic_source: IV_UTM.source,
      traffic_medium: IV_UTM.medium,
      traffic_campaign: IV_UTM.campaign,
      device_type: IV_DEVICE,
      landing_page: window.location.pathname,
      referrer: document.referrer || 'none'
  });
</script> 
    <!-- Meta Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '897308342823736');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=897308342823736&ev=PageView&noscript=1"
/></noscript>
<!-- End Meta Pixel Code -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Value ‚Äî Scan Any Item. Know If It's Worth Selling.</title>
    <meta name="description" content="AI-powered app that tells you if your stuff is worth selling. Snap a photo, get instant value. Free to try.">
    
    <!-- PWA Configuration -->
    <meta name="theme-color" content="#0D7C66">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/icon.svg">
    
    <!-- iOS specific -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Item Value">
    <link rel="apple-touch-icon" href="/icon.svg">
    
    <!-- Fonts - matching landing page -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Fraunces:ital,opsz,wght@0,9..144,400;0,9..144,600;0,9..144,700;1,9..144,400&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root {
            --color-bg: #FDFBF7;
            --color-bg-alt: #F5F1E8;
            --color-text: #1a1a1a;
            --color-text-muted: #5a5a5a;
            --color-primary: #0D7C66;
            --color-primary-dark: #095C4B;
            --color-accent: #E8B931;
            --color-accent-light: #FDF4D7;
            --color-contrast: #1E3A34;
            --color-success: #0D7C66;
            --color-warning: #E8B931;
            --color-error: #dc2626;
            --font-display: 'Fraunces', Georgia, serif;
            --font-body: 'DM Sans', -apple-system, sans-serif;
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.06);
            --shadow-medium: 0 8px 30px rgba(0,0,0,0.1);
            --radius: 12px;
            --radius-lg: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: var(--color-bg);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 60px;
            color: var(--color-text);
        }

        .container { max-width: 500px; margin: 0 auto; }

        .card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 30px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 20px;
            border: 1px solid rgba(0,0,0,0.04);
        }

        h1 {
            font-family: var(--font-display);
            color: var(--color-contrast);
            font-size: 28px;
            margin-bottom: 10px;
            text-align: center;
            line-height: 1.2;
            font-weight: 600;
        }

        h1 .highlight { color: var(--color-primary); }

        .subtitle {
            color: var(--color-text-muted);
            text-align: center;
            margin-bottom: 25px;
            font-size: 16px;
        }

        .ai-badge {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 15px;
            letter-spacing: 0.3px;
        }

        .pro-badge {
            background: linear-gradient(135deg, var(--color-accent) 0%, #D4A528 100%);
            color: var(--color-contrast);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 15px;
        }

        .input-section { margin-top: 10px; }

        .input-label {
            display: block;
            font-family: var(--font-display);
            font-weight: 600;
            color: var(--color-contrast);
            margin-bottom: 12px;
            font-size: 18px;
            text-align: center;
        }

        input[type="text"], input[type="number"], input[type="email"], textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: var(--radius);
            font-size: 18px;
            font-weight: 500;
            font-family: var(--font-body);
            transition: border-color 0.2s, box-shadow 0.2s;
            background: white;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(13, 124, 102, 0.1);
        }

        input::placeholder, textarea::placeholder { color: #94a3b8; }
        textarea { resize: vertical; }

        .action-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 15px;
            font-family: var(--font-body);
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(13, 124, 102, 0.4);
        }

        .action-button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .action-button.pro {
            background: linear-gradient(135deg, var(--color-accent) 0%, #D4A528 100%);
            color: var(--color-contrast);
        }

        .time-hint {
            text-align: center;
            color: var(--color-text-muted);
            font-size: 14px;
            margin-top: 12px;
        }

        .time-hint span {
            color: var(--color-primary);
            font-weight: 600;
        }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .button-grid.single-col { grid-template-columns: 1fr; }

        .option-button {
            padding: 16px 12px;
            border: 2px solid #e0e0e0;
            border-radius: var(--radius);
            background: white;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-weight: 500;
            color: var(--color-text);
            font-family: var(--font-body);
        }

        .option-button:hover {
            border-color: var(--color-primary);
            background: rgba(13, 124, 102, 0.05);
        }

        .option-button.selected {
            border-color: var(--color-primary);
            background: var(--color-primary);
            color: white;
        }

        .back-button {
            background: transparent;
            border: 2px solid #cbd5e1;
            color: var(--color-text-muted);
            width: 100%;
            padding: 14px;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s;
            font-family: var(--font-body);
        }

        .back-button:hover {
            border-color: #94a3b8;
            color: var(--color-text);
            background: var(--color-bg-alt);
        }

        .result-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 30px;
            box-shadow: var(--shadow-medium);
            text-align: center;
            border: 1px solid rgba(0,0,0,0.04);
        }

        .result-icon { font-size: 64px; margin-bottom: 20px; }

        .result-title {
            font-family: var(--font-display);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .result-title.sell { color: var(--color-primary); }
        .result-title.donate { color: var(--color-accent); }

        .result-reason {
            color: var(--color-text-muted);
            font-size: 16px;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .result-details {
            background: var(--color-bg-alt);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }

        .detail-row:last-child { border-bottom: none; }
        .detail-label { color: var(--color-text-muted); font-weight: 500; }
        .detail-value { font-weight: 700; color: var(--color-text); }
        .detail-value.highlight { color: var(--color-primary); font-size: 20px; }

        .market-data {
            background: rgba(13, 124, 102, 0.08);
            border-left: 4px solid var(--color-primary);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            text-align: left;
        }

        .market-data-title {
            font-weight: 600;
            color: var(--color-primary-dark);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .market-data-content {
            color: var(--color-contrast);
            font-size: 14px;
            line-height: 1.5;
        }

        .effort-score {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .effort-score.easy {
            background: rgba(13, 124, 102, 0.15);
            color: var(--color-primary-dark);
            border: 2px solid var(--color-primary);
        }

        .effort-score.medium {
            background: var(--color-accent-light);
            color: #92700C;
            border: 2px solid var(--color-accent);
        }

        .effort-score.hard {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }

        .loading { text-align: center; padding: 40px; }

        .loading-spinner {
            border: 4px solid var(--color-bg-alt);
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-spinner.pro { border-top-color: var(--color-accent); }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text { color: var(--color-primary); font-weight: 600; font-size: 16px; }
        .loading-text.pro { color: #92700C; }
        .loading-subtext { color: var(--color-text-muted); font-size: 14px; margin-top: 8px; }

        .scan-counter {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--color-contrast), #2D4A42);
            color: white;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow-medium);
            z-index: 1000;
            transition: all 0.2s;
        }

        .scan-counter:hover { transform: translateY(-2px); }
        .scan-counter.warning { background: linear-gradient(135deg, var(--color-accent), #D4A528); color: var(--color-contrast); }
        .scan-counter.empty { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .scan-counter.paid { background: linear-gradient(135deg, var(--color-accent), #D4A528); color: var(--color-contrast); }

        .history-button {
            position: fixed;
            bottom: 60px;
            right: 20px;
            background: linear-gradient(135deg, var(--color-contrast), #2D4A42);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--shadow-medium);
            z-index: 1000;
            font-family: var(--font-body);
        }

        .history-badge {
            background: var(--color-accent);
            color: var(--color-contrast);
            border-radius: 50%;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 8px;
        }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: 30px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            width: 100%;
            box-shadow: var(--shadow-medium);
        }

        .scan-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            background: var(--color-bg-alt);
            border-radius: var(--radius);
            padding: 4px;
        }

        .scan-tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            font-family: var(--font-body);
            font-weight: 600;
            font-size: 14px;
            color: var(--color-text-muted);
            cursor: pointer;
            border-radius: calc(var(--radius) - 2px);
            transition: all 0.2s;
        }

        .scan-tab.active {
            background: white;
            color: var(--color-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .photo-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: var(--radius);
            padding: 30px 20px;
            text-align: center;
            background: var(--color-bg-alt);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .photo-upload-area:hover {
            border-color: var(--color-primary);
            background: rgba(13, 124, 102, 0.05);
        }

        .photo-upload-area.has-image {
            border-style: solid;
            border-color: var(--color-primary);
            padding: 10px;
        }

        .upload-icon { font-size: 48px; margin-bottom: 10px; }

        .upload-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .upload-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-family: var(--font-body);
            font-size: 14px;
        }

        .upload-btn.camera { background: var(--color-primary); color: white; }
        .upload-btn.gallery { background: #e5e7eb; color: #374151; }

        .preview-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
        }

        .preview-image {
            max-width: 100%;
            max-height: 250px;
            object-fit: contain;
            border-radius: 8px;
        }

        .clear-preview {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: rgba(0,0,0,0.7);
            color: white;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-analyzing {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
        }

        .photo-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--color-bg-alt);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 15px;
        }

        .photo-error {
            background: #fef2f2;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--color-bg-alt);
        }

        .history-title {
            font-family: var(--font-display);
            font-size: 20px;
            font-weight: 700;
            color: var(--color-contrast);
        }

        .history-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(13, 124, 102, 0.08);
            border-radius: var(--radius);
        }

        .stat-box { text-align: center; }
        .stat-number { font-family: var(--font-display); font-size: 24px; font-weight: 700; color: var(--color-contrast); }
        .stat-label { font-size: 12px; color: var(--color-text-muted); }

        .history-item {
            background: var(--color-bg-alt);
            border-left: 4px solid #cbd5e1;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .history-item.sell { border-left-color: var(--color-primary); }
        .history-item.donate { border-left-color: var(--color-accent); }

        .close-button {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: var(--font-body);
        }

        @keyframes emailSpinner { to { transform: rotate(360deg); } }
    </style>
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "v9pa63sy1j");
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ============================================
        // CONFIGURATION
        // ============================================
        const SCAN_CONFIG = {
            FREE_SCANS: 3,
            SALES_PAGE_URL: '/pricing.html'
        };

        // ============================================
        // IMPROVED GA4 TRACKING WITH ATTRIBUTION
        // ============================================
        function trackEvent(eventName, eventParams = {}) {
            // Get scan data for context
            let scanContext = { tier: 'free', scansRemaining: 0 };
            try {
                const data = localStorage.getItem('itemvalue_scans');
                if (data) scanContext = JSON.parse(data);
            } catch(e) {}

            // Build enhanced params with attribution
            const enhanced = {
                ...eventParams,
                // Session & attribution (from head script)
                session_id: window.IV_SESSION || sessionStorage.getItem('iv_sid') || 'unknown',
                traffic_source: (window.IV_UTM || JSON.parse(sessionStorage.getItem('iv_utm') || '{}')).source || 'direct',
                traffic_medium: (window.IV_UTM || JSON.parse(sessionStorage.getItem('iv_utm') || '{}')).medium || 'none',
                traffic_campaign: (window.IV_UTM || JSON.parse(sessionStorage.getItem('iv_utm') || '{}')).campaign || 'none',
                // Device
                device_type: window.IV_DEVICE || (/iPhone|iPad|iPod/.test(navigator.userAgent) ? 'ios' : /Android/.test(navigator.userAgent) ? 'android' : 'desktop'),
                // User state
                user_tier: scanContext.tier,
                scans_remaining: scanContext.scansRemaining
            };

            // GA4 tracking
            if (typeof gtag !== 'undefined') {
                gtag('event', eventName, enhanced);
                console.log('üìä GA4:', eventName, enhanced);
            }
            
            // Meta Pixel tracking for key conversion events
            if (typeof fbq !== 'undefined') {
                // Unified scan completion event
                if (eventName === 'scan_completed') {
                    fbq('track', 'Lead', {
                        content_name: eventParams.item_name || eventParams.item_category || 'item_scan',
                        content_category: eventParams.scan_type || 'quick',
                        value: eventParams.estimated_value || 0,
                        currency: 'USD'
                    });
                    console.log('üìò Meta: Lead');
                }
                if (eventName === 'item_entered') {
                    fbq('track', 'Search', { search_string: 'item_entered' });
                }
                if (eventName === 'paywall_shown' || eventName === 'upgrade_cta_clicked') {
                    fbq('track', 'ViewContent', { content_name: 'pricing_interest' });
                }
                if (eventName === 'email_captured') {
                    fbq('track', 'CompleteRegistration', { content_name: 'email_capture' });
                }
                if (eventName === 'bundle_activated') {
                    fbq('track', 'Purchase', {
                        value: eventParams.purchase_value || 0,
                        currency: 'USD',
                        content_name: eventParams.bundle_name
                    });
                }
            }
        }

        // Track engagement start (first interaction)
        function trackEngagement(inputType) {
            if (sessionStorage.getItem('iv_engaged')) return;
            sessionStorage.setItem('iv_engaged', 'true');
            trackEvent('engagement_start', { input_type: inputType });
        }

        // ============================================
        // SCAN MANAGEMENT
        // ============================================
        function getScanData() {
            try {
                const data = localStorage.getItem('itemvalue_scans');
                if (data) {
                    const parsed = JSON.parse(data);
                    if (parsed.expiryDate && new Date(parsed.expiryDate) < new Date()) {
                        const freshData = { tier: 'free', scansRemaining: SCAN_CONFIG.FREE_SCANS, totalScans: SCAN_CONFIG.FREE_SCANS, used: 0, expiryDate: null, bundle: null };
                        localStorage.setItem('itemvalue_scans', JSON.stringify(freshData));
                        return freshData;
                    }
                    return parsed;
                }
            } catch (e) { console.error('Error reading scan data:', e); }
            
            const defaultData = { tier: 'free', scansRemaining: SCAN_CONFIG.FREE_SCANS, totalScans: SCAN_CONFIG.FREE_SCANS, used: 0, expiryDate: null, bundle: null };
            localStorage.setItem('itemvalue_scans', JSON.stringify(defaultData));
            return defaultData;
        }

        function saveScanData(data) { localStorage.setItem('itemvalue_scans', JSON.stringify(data)); }

        function decrementScan() {
            const data = getScanData();
            if (data.scansRemaining > 0) {
                data.scansRemaining--;
                data.used = (data.used || 0) + 1;
                saveScanData(data);
            }
            return data;
        }

        function canScan() { return getScanData().scansRemaining > 0; }
        function isPaidUser() { return getScanData().tier === 'paid'; }

        // Check for access code in URL
        function checkAccessCode() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                window.history.replaceState({}, document.title, window.location.pathname);
                activateAccessCode(code);
            }
        }
      
        function activateAccessCode(code) {
            const upperCode = code.toUpperCase();
            let bundle = null, scans = 0, days = 0, purchaseValue = 0;
            
            if (upperCode === 'SINGLE2') { bundle = 'Single Scan'; scans = 1; days = 30; purchaseValue = 2; }
            else if (upperCode === 'STARTER25') { bundle = 'Starter Pack'; scans = 25; days = 365; purchaseValue = 7; }
            else if (upperCode === 'CHALLENGE100') { bundle = 'Challenge Bundle'; scans = 100; days = 365; purchaseValue = 27; }
            else if (upperCode.includes('WEEKEND')) { bundle = 'Weekend Warrior'; scans = 50; days = upperCode.includes('YEAR') ? 365 : 30; purchaseValue = 17; }
            else if (upperCode.includes('MOVING')) { bundle = 'Moving Master'; scans = 200; days = upperCode.includes('YEAR') ? 365 : 60; purchaseValue = 37; }
            else if (upperCode.includes('ESTATE')) { bundle = 'Estate Pro'; scans = 1000; days = upperCode.includes('YEAR') ? 365 : 90; purchaseValue = 97; }
            else { alert('Invalid access code. Please check and try again.'); return; }
           
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + days);
            
            const scanData = {
                tier: 'paid', bundle, scansRemaining: scans, totalScans: scans, used: 0,
                expiryDate: expiryDate.toISOString(), activatedDate: new Date().toISOString(), accessCode: code
            };
            
            saveScanData(scanData);
            trackEvent('bundle_activated', { bundle_name: bundle, scans_granted: scans, purchase_value: purchaseValue });
            alert(`‚úÖ ${bundle} activated! You have ${scans} scans.`);
            return true;
        }

        checkAccessCode();

        const CONDITIONS = [
            { id: 'new', label: 'üì¶ New/Sealed' },
            { id: 'likenew', label: '‚ú® Like New' },
            { id: 'good', label: 'üëç Good' },
            { id: 'fair', label: 'üëå Fair/Worn' },
        ];

        // ============================================
        // COMPONENTS
        // ============================================
        function ScanCounter({ onClick }) {
            const data = getScanData();
            const remaining = data.scansRemaining;
            const isPaid = data.tier === 'paid';
            
            let className = 'scan-counter';
            if (isPaid) className += ' paid';
            else if (remaining <= 0) className += ' empty';
            else if (remaining <= 1) className += ' warning';
            
            return (
                <div className={className} onClick={onClick}>
                    {isPaid ? '‚ú®' : 'üÜì'} {remaining} {isPaid ? 'scans' : 'free'} left
                </div>
            );
        }

        function UpgradeModal({ onClose, onShowEmailCapture }) {
            useEffect(() => {
                trackEvent('paywall_shown', { scans_used: getScanData().used || 0 });
            }, []);

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '420px', textAlign: 'center'}}>
                        <div style={{fontSize: '56px', marginBottom: '15px'}}>üîç</div>
                        <h2 style={{fontFamily: 'var(--font-display)', color: 'var(--color-contrast)', marginBottom: '12px', fontSize: '22px'}}>You've Used Your Free Scans!</h2>
                        <p style={{color: 'var(--color-text-muted)', marginBottom: '20px', fontSize: '15px', lineHeight: '1.5'}}>
                            Upgrade to keep discovering hidden value. Most users find $500+ worth of sellable items!
                        </p>
                        
                        <button onClick={() => { trackEvent('upgrade_cta_clicked'); onClose(); onShowEmailCapture(); }}
                            style={{ width: '100%', padding: '14px', background: 'linear-gradient(135deg, var(--color-primary), var(--color-primary-dark))', color: 'white', border: 'none', borderRadius: 'var(--radius)', fontSize: '16px', fontWeight: '600', cursor: 'pointer', marginBottom: '10px', fontFamily: 'var(--font-body)' }}>
                            View Pricing Options ‚Üí
                        </button>
                        
                        <button onClick={() => { trackEvent('upgrade_dismissed'); onClose(); }}
                            style={{ width: '100%', padding: '12px', background: 'transparent', color: 'var(--color-text-muted)', border: '2px solid #e2e8f0', borderRadius: 'var(--radius)', fontSize: '15px', cursor: 'pointer', fontFamily: 'var(--font-body)' }}>
                            Maybe Later
                        </button>
                    </div>
                </div>
            );
        }

        function AccountModal({ onClose }) {
            const data = getScanData();
            const isPaid = data.tier === 'paid';
            let expiryText = 'N/A';
            if (data.expiryDate) {
                const daysLeft = Math.ceil((new Date(data.expiryDate) - new Date()) / (1000 * 60 * 60 * 24));
                expiryText = `${daysLeft} days left`;
            }
            
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '380px'}}>
                        <h2 style={{marginBottom: '20px', color: 'var(--color-contrast)', fontFamily: 'var(--font-display)'}}>üìä Your Account</h2>
                        <div style={{background: 'var(--color-bg-alt)', padding: '20px', borderRadius: 'var(--radius)', marginBottom: '20px'}}>
                            <div style={{marginBottom: '15px'}}>
                                <div style={{color: 'var(--color-text-muted)', fontSize: '13px'}}>Plan</div>
                                <div style={{color: 'var(--color-contrast)', fontSize: '18px', fontWeight: '700', fontFamily: 'var(--font-display)'}}>{isPaid ? data.bundle : 'Free Tier'}</div>
                            </div>
                            <div style={{marginBottom: isPaid ? '15px' : '0'}}>
                                <div style={{color: 'var(--color-text-muted)', fontSize: '13px'}}>Scans Remaining</div>
                                <div style={{color: 'var(--color-primary)', fontSize: '24px', fontWeight: '700', fontFamily: 'var(--font-display)'}}>{data.scansRemaining} / {data.totalScans}</div>
                            </div>
                            {isPaid && (
                                <div>
                                    <div style={{color: 'var(--color-text-muted)', fontSize: '13px'}}>Expires</div>
                                    <div style={{color: 'var(--color-contrast)', fontSize: '16px', fontWeight: '600'}}>{expiryText}</div>
                                </div>
                            )}
                        </div>
                        {!isPaid && (
                            <a href={SCAN_CONFIG.SALES_PAGE_URL} style={{ display: 'block', padding: '14px', background: 'linear-gradient(135deg, var(--color-primary), var(--color-primary-dark))', color: 'white', borderRadius: 'var(--radius)', fontSize: '15px', fontWeight: '600', textAlign: 'center', textDecoration: 'none', marginBottom: '10px' }}>
                                Upgrade for More Scans
                            </a>
                        )}
                        <button onClick={onClose} style={{ width: '100%', padding: '12px', background: 'var(--color-text-muted)', color: 'white', border: 'none', borderRadius: 'var(--radius)', fontSize: '15px', fontWeight: '600', cursor: 'pointer', fontFamily: 'var(--font-body)' }}>Close</button>
                    </div>
                </div>
            );
        }

        function EmailCaptureModal({ onClose, lastItem }) {
            const [email, setEmail] = useState('');
            const [firstName, setFirstName] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = async () => {
                if (!email || !email.includes('@')) { alert('Please enter a valid email'); return; }
                setIsLoading(true);
                trackEvent('email_captured', { has_first_name: !!firstName });
                try {
                    await fetch('/.netlify/functions/capture-email', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, firstName: firstName || null, scansUsed: getScanData().used || 3, lastItemScanned: lastItem })
                    });
                    localStorage.setItem('itemvalue_user_email', email);
                } catch (e) { console.error('Email capture error:', e); }
                window.location.href = SCAN_CONFIG.SALES_PAGE_URL;
            };

            const handleSkip = () => { trackEvent('email_skipped'); window.location.href = SCAN_CONFIG.SALES_PAGE_URL; };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '420px', position: 'relative'}}>
                        <div style={{background: 'linear-gradient(135deg, var(--color-primary), var(--color-primary-dark))', padding: '25px', margin: '-30px -30px 25px -30px', borderRadius: 'var(--radius-lg) var(--radius-lg) 0 0', textAlign: 'center'}}>
                            <div style={{fontSize: '48px', marginBottom: '10px'}}>üîç</div>
                            <h2 style={{color: 'white', margin: '0', fontSize: '20px', fontFamily: 'var(--font-display)'}}>You've Used Your Free Scans!</h2>
                        </div>
                        {!isLoading ? (
                            <>
                                <p style={{color: 'var(--color-text-muted)', marginBottom: '15px', fontSize: '15px'}}>Enter your email for <strong>exclusive pricing</strong>:</p>
                                <input type="text" placeholder="First name (optional)" value={firstName} onChange={(e) => setFirstName(e.target.value)} style={{width: '100%', padding: '12px 14px', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '16px', marginBottom: '10px', fontFamily: 'var(--font-body)'}} />
                                <input type="email" placeholder="Email address" value={email} onChange={(e) => setEmail(e.target.value)} style={{width: '100%', padding: '12px 14px', border: '2px solid #e2e8f0', borderRadius: '8px', fontSize: '16px', marginBottom: '15px', fontFamily: 'var(--font-body)'}} />
                                <button onClick={handleSubmit} style={{ width: '100%', background: 'linear-gradient(135deg, var(--color-primary), var(--color-primary-dark))', color: 'white', padding: '14px', border: 'none', borderRadius: '8px', fontSize: '16px', fontWeight: '600', cursor: 'pointer', fontFamily: 'var(--font-body)' }}>See My Options ‚Üí</button>
                                <p style={{textAlign: 'center', marginTop: '12px'}}><a onClick={handleSkip} style={{color: '#94a3b8', fontSize: '13px', cursor: 'pointer'}}>No thanks, I'll pay full price ‚Üí</a></p>
                            </>
                        ) : (
                            <div style={{textAlign: 'center', padding: '20px'}}>
                                <div style={{width: '40px', height: '40px', border: '3px solid #e2e8f0', borderTopColor: 'var(--color-primary)', borderRadius: '50%', animation: 'emailSpinner 1s linear infinite', margin: '0 auto 15px'}}></div>
                                <p style={{color: 'var(--color-text-muted)'}}>Saving...</p>
                            </div>
                        )}
                        <button onClick={onClose} style={{position: 'absolute', top: '15px', right: '15px', background: 'rgba(255,255,255,0.2)', border: 'none', color: 'white', width: '30px', height: '30px', borderRadius: '50%', fontSize: '16px', cursor: 'pointer'}}>√ó</button>
                    </div>
                </div>
            );
        }

        function HistoryModal({ history, onClose, onClear }) {
            const sellItems = history.filter(item => item.recommendation === 'sell');
            const totalProfit = sellItems.reduce((sum, item) => sum + parseFloat(item.netProfit || 0), 0);

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="history-header">
                            <h2 className="history-title">üìã History</h2>
                            <div style={{display: 'flex', gap: '8px'}}>
                                <button onClick={onClear} style={{background: 'var(--color-bg-alt)', border: 'none', padding: '8px 12px', borderRadius: '8px', cursor: 'pointer', fontSize: '13px', fontFamily: 'var(--font-body)'}}>üóëÔ∏è Clear</button>
                                <button className="close-button" onClick={onClose}>‚úï</button>
                            </div>
                        </div>
                        <div className="history-stats">
                            <div className="stat-box"><div className="stat-number">{history.length}</div><div className="stat-label">Items</div></div>
                            <div className="stat-box"><div className="stat-number" style={{color: 'var(--color-primary)'}}>{sellItems.length}</div><div className="stat-label">Sell</div></div>
                            <div className="stat-box"><div className="stat-number" style={{color: '#92700C'}}>{history.length - sellItems.length}</div><div className="stat-label">Donate</div></div>
                        </div>
                        {sellItems.length > 0 && (
                            <div style={{marginBottom: '15px', padding: '12px', background: 'rgba(13, 124, 102, 0.08)', borderRadius: '10px', textAlign: 'center'}}>
                                <div style={{fontSize: '13px', color: 'var(--color-primary-dark)'}}>Potential profit</div>
                                <div style={{fontSize: '24px', fontWeight: '700', color: 'var(--color-primary)', fontFamily: 'var(--font-display)'}}>${totalProfit.toFixed(2)}</div>
                            </div>
                        )}
                        <div style={{maxHeight: '300px', overflowY: 'auto'}}>
                            {history.map((item) => (
                                <div key={item.id} className={`history-item ${item.recommendation}`}>
                                    <div style={{fontWeight: '600', color: 'var(--color-contrast)', marginBottom: '4px', fontFamily: 'var(--font-display)'}}>{item.itemName}</div>
                                    <div style={{fontSize: '13px'}}>
                                        <span style={{color: item.recommendation === 'sell' ? 'var(--color-primary)' : '#92700C', fontWeight: '600'}}>{item.recommendation === 'sell' ? 'üí∞ SELL' : '‚ù§Ô∏è DONATE'}</span>
                                        {item.recommendation === 'sell' && <span style={{color: 'var(--color-text-muted)', marginLeft: '10px'}}>Net: ${item.netProfit}</span>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // MAIN APP
        // ============================================
        function App() {
            const [screen, setScreen] = useState('home');
            const [itemDescription, setItemDescription] = useState('');
            const [scanMode, setScanMode] = useState('photo');
            const [photoPreview, setPhotoPreview] = useState(null);
            const [photoFile, setPhotoFile] = useState(null);
            const [photoLoading, setPhotoLoading] = useState(false);
            const [photoError, setPhotoError] = useState(null);
            const [condition, setCondition] = useState(null);
            const [result, setResult] = useState(null);
            const [history, setHistory] = useState(() => {
                const saved = localStorage.getItem('sellDonateHistory');
                return saved ? JSON.parse(saved) : [];
            });
            const [scanData, setScanData] = useState(getScanData());
            
            const [showUpgrade, setShowUpgrade] = useState(false);
            const [showAccount, setShowAccount] = useState(false);
            const [showEmailCapture, setShowEmailCapture] = useState(false);
            const [showHistory, setShowHistory] = useState(false);

            const refreshScanData = () => setScanData(getScanData());

            // Photo scan functions
            const handlePhotoSelect = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (!file.type.startsWith('image/')) { setPhotoError('Please select an image file'); return; }
                if (file.size > 10 * 1024 * 1024) { setPhotoError('Image must be under 10MB'); return; }
                
                setPhotoError(null);
                setPhotoFile(file);
                const reader = new FileReader();
                reader.onload = (e) => setPhotoPreview(e.target.result);
                reader.readAsDataURL(file);
                
                trackEngagement('photo');
                trackEvent('photo_selected', { source: 'gallery' });
            };

            const clearPhoto = () => { setPhotoPreview(null); setPhotoFile(null); setPhotoError(null); };

            const runPhotoAnalysis = async () => {
                if (!photoFile) return;
                if (!canScan()) { setShowUpgrade(true); return; }
                
                setPhotoLoading(true);
                setPhotoError(null);
                trackEvent('scan_started', { scan_type: 'photo' });
                
                try {
                    const base64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = reject;
                        reader.readAsDataURL(photoFile);
                    });
                    
                    const response = await fetch('/.netlify/functions/scan-photo', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: base64, mimeType: photoFile.type }),
                    });
                    
                    if (!response.ok) throw new Error((await response.json()).error || 'Scan failed');
                    
                    const photoResult = await response.json();
                    decrementScan();
                    refreshScanData();
                    
                    // UNIFIED scan_completed event
                    trackEvent('scan_completed', {
                        scan_type: 'photo',
                        item_name: photoResult.itemName,
                        recommendation: photoResult.estimatedValue >= 10 ? 'sell' : 'donate',
                        estimated_value: photoResult.estimatedValue,
                        confidence: photoResult.confidence
                    });
                    
                    const formattedResult = {
                        recommendation: photoResult.estimatedValue >= 10 ? 'sell' : 'donate',
                        reason: photoResult.tips,
                        effortScore: photoResult.confidence === 'high' ? 'easy' : photoResult.confidence === 'medium' ? 'medium' : 'hard',
                        marketData: `Best platforms: ${photoResult.bestPlatforms.join(', ')}`,
                        estimatedPrice: photoResult.valueRange.high.toFixed(2),
                        netProfit: photoResult.estimatedValue.toFixed(2),
                        analysisType: 'photo'
                    };
                    
                    setResult(formattedResult);
                    setScreen('result');
                    
                    const historyItem = { id: Date.now(), timestamp: new Date().toISOString(), itemName: photoResult.itemName, analysisType: 'photo', ...formattedResult };
                    const updatedHistory = [historyItem, ...history];
                    setHistory(updatedHistory);
                    localStorage.setItem('sellDonateHistory', JSON.stringify(updatedHistory));
                    clearPhoto();
                    
                } catch (error) {
                    console.error('Photo scan error:', error);
                    setPhotoError(error.message || 'Failed to analyze image.');
                    trackEvent('scan_error', { scan_type: 'photo', error: error.message });
                } finally {
                    setPhotoLoading(false);
                }
            };

            const handleShowEmailCapture = () => {
                if (localStorage.getItem('itemvalue_user_email')) {
                    window.location.href = SCAN_CONFIG.SALES_PAGE_URL;
                } else {
                    setShowEmailCapture(true);
                }
            };

            const startAnalysis = () => {
                if (!canScan()) { setShowUpgrade(true); return; }
                if (!itemDescription.trim()) return;
                trackEngagement('text');
                trackEvent('item_entered', { item_length: itemDescription.length, item_preview: itemDescription.substring(0, 30) });
                setScreen('condition');
            };

            const runAnalysis = async () => {
                if (!canScan()) { setShowUpgrade(true); return; }
                setScreen('loading');
                trackEvent('scan_started', { scan_type: 'text', item_preview: itemDescription.substring(0, 30) });

                const conditionLabel = CONDITIONS.find(c => c.id === condition)?.label.split(' ').slice(1).join(' ');

                try {
                    const response = await fetch('/.netlify/functions/analyze', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ itemDescription, category: 'General', condition: conditionLabel, originalPrice: '', urgency: 'Whenever it Sells', brand: '', defects: '', additionalInfo: '' })
                    });

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const data = await response.json();
                    let responseText = '';
                    if (data.content) { for (const block of data.content) { if (block.type === 'text') responseText += block.text; } }

                    let cleanedResponse = responseText.trim().replace(/```json\n?/g, '').replace(/```\n?/g, '');
                    const jsonMatch = cleanedResponse.match(/\{[\s\S]*\}/);
                    if (jsonMatch) cleanedResponse = jsonMatch[0];

                    const aiResult = JSON.parse(cleanedResponse);

                    const resultData = {
                        recommendation: aiResult.recommendation.toLowerCase(),
                        reason: aiResult.reason,
                        effortScore: aiResult.effortScore || 'medium',
                        marketData: aiResult.marketData,
                        estimatedPrice: parseFloat(aiResult.estimatedSalePrice).toFixed(2),
                        netProfit: parseFloat(aiResult.netProfit).toFixed(2),
                        analysisType: 'quick'
                    };

                    setResult(resultData);
                    setScreen('result');

                    // UNIFIED scan_completed event
                    trackEvent('scan_completed', {
                        scan_type: 'text',
                        item_name: itemDescription,
                        recommendation: resultData.recommendation,
                        estimated_value: parseFloat(resultData.estimatedPrice),
                        net_profit: parseFloat(resultData.netProfit)
                    });

                    decrementScan();
                    refreshScanData();

                    const historyItem = { id: Date.now(), timestamp: new Date().toISOString(), itemName: itemDescription, condition, analysisType: 'quick', ...resultData };
                    const updatedHistory = [historyItem, ...history];
                    setHistory(updatedHistory);
                    localStorage.setItem('sellDonateHistory', JSON.stringify(updatedHistory));

                } catch (error) {
                    console.error('Analysis error:', error);
                    trackEvent('scan_error', { scan_type: 'text', error: 'api_error' });
                    alert('Something went wrong. Please try again.');
                    setScreen('home');
                }
            };

            const reset = () => {
                setScreen('home');
                setItemDescription('');
                setCondition(null);
                setResult(null);
                refreshScanData();
            };

            // ============================================
            // SCREENS
            // ============================================
            if (screen === 'loading') {
                return (
                    <>
                        <ScanCounter onClick={() => setShowAccount(true)} />
                        <div className="container">
                            <div className="card">
                                <div className="loading">
                                    <div className="loading-spinner"></div>
                                    <div className="loading-text">üîç Searching marketplace data...</div>
                                    <div className="loading-subtext">Finding real sold prices for your item</div>
                                </div>
                            </div>
                        </div>
                        {showAccount && <AccountModal onClose={() => setShowAccount(false)} />}
                    </>
                );
            }

            if (screen === 'home') {
                return (
                    <>
                        <ScanCounter onClick={() => setShowAccount(true)} />
                        <div className="container">
                            <div className="card">
                                <div style={{textAlign: 'center'}}><div className="ai-badge">üì∑ Instant Item Scanner</div></div>
                                <h1>Snap a Photo.<br/><span className="highlight">Know If It's Worth Selling.</span></h1>
                                <p className="subtitle">Get real profit estimates after fees and shipping ‚Äî instantly.</p>

                                <div className="input-section">
                                    <div className="scan-tabs">
                                        <button className={`scan-tab ${scanMode === 'photo' ? 'active' : ''}`} onClick={() => setScanMode('photo')}>üì∑ Photo Scan</button>
                                        <button className={`scan-tab ${scanMode === 'text' ? 'active' : ''}`} onClick={() => setScanMode('text')}>‚úèÔ∏è Type Item</button>
                                    </div>

                                    {scanMode === 'photo' ? (
                                        <>
                                            <input type="file" id="photoInput" accept="image/*" onChange={handlePhotoSelect} style={{ display: 'none' }} />
                                            <input type="file" id="cameraInput" accept="image/*" capture="environment" onChange={handlePhotoSelect} style={{ display: 'none' }} />
                                            
                                            {photoLoading ? (
                                                <div className="photo-analyzing">
                                                    <div className="photo-spinner"></div>
                                                    <p style={{color: 'var(--color-primary)', fontWeight: '600'}}>Analyzing your item...</p>
                                                    <p style={{color: 'var(--color-text-muted)', fontSize: '14px'}}>This takes about 10 seconds</p>
                                                </div>
                                            ) : photoPreview ? (
                                                <div className="photo-upload-area has-image">
                                                    <div className="preview-container">
                                                        <img src={photoPreview} alt="Item preview" className="preview-image" />
                                                        <button className="clear-preview" onClick={clearPhoto}>‚úï</button>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="photo-upload-area" onClick={() => document.getElementById('cameraInput').click()}>
                                                    <div className="upload-icon">üì∑</div>
                                                    <p style={{color: 'var(--color-text)', fontWeight: '600', marginBottom: '5px'}}>Take a photo of your item</p>
                                                    <p style={{color: 'var(--color-text-muted)', fontSize: '14px'}}>Works best with clear, well-lit photos</p>
                                                    <div className="upload-buttons" onClick={(e) => e.stopPropagation()}>
                                                        <button className="upload-btn camera" onClick={() => document.getElementById('cameraInput').click()}>üì∏ Take Photo</button>
                                                        <button className="upload-btn gallery" onClick={() => document.getElementById('photoInput').click()}>üñºÔ∏è Gallery</button>
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {photoError && <div className="photo-error">{photoError}</div>}
                                            {photoPreview && !photoLoading && <button className="action-button" onClick={runPhotoAnalysis}>‚ú® Scan This Item ‚Äî Free</button>}
                                            <div className="time-hint">‚è± Takes about <span>10 seconds</span> ‚Ä¢ No signup required</div>
                                        </>
                                    ) : (
                                        <>
                                            <label className="input-label">What do you want to check?</label>
                                            <input type="text" autoFocus placeholder="e.g., KitchenAid mixer, Levi's jeans, old iPad..." value={itemDescription} onChange={(e) => { setItemDescription(e.target.value); if (e.target.value.length === 1) trackEngagement('text'); }} onKeyPress={(e) => e.key === 'Enter' && startAnalysis()} />
                                            <button className="action-button" disabled={!itemDescription.trim()} onClick={startAnalysis}>{itemDescription.trim() ? 'Check My Item ‚Äî Free ‚úì' : 'Enter an item above'}</button>
                                            <div className="time-hint">‚è± Takes about <span>30 seconds</span> ‚Ä¢ No signup required</div>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>

                        {history.length > 0 && <button className="history-button" onClick={() => setShowHistory(true)}>üìã History <span className="history-badge">{history.length}</span></button>}
                        {showHistory && <HistoryModal history={history} onClose={() => setShowHistory(false)} onClear={() => { setHistory([]); localStorage.removeItem('sellDonateHistory'); setShowHistory(false); }} />}
                        {showAccount && <AccountModal onClose={() => setShowAccount(false)} />}
                        {showUpgrade && <UpgradeModal onClose={() => setShowUpgrade(false)} onShowEmailCapture={handleShowEmailCapture} />}
                        {showEmailCapture && <EmailCaptureModal onClose={() => setShowEmailCapture(false)} lastItem={null} />}
                    </>
                );
            }

            if (screen === 'condition') {
                return (
                    <>
                        <ScanCounter onClick={() => setShowAccount(true)} />
                        <div className="container">
                            <div className="card">
                                <div style={{textAlign: 'center', marginBottom: '5px'}}><div className="ai-badge">‚ö° Quick Check</div></div>
                                <h1 style={{fontSize: '22px', marginBottom: '8px'}}>What condition is it in?</h1>
                                <p className="subtitle" style={{marginBottom: '20px'}}>Checking: <strong>{itemDescription}</strong></p>
                                <div className="button-grid">
                                    {CONDITIONS.map(cond => (
                                        <button key={cond.id} className={`option-button ${condition === cond.id ? 'selected' : ''}`} onClick={() => setCondition(cond.id)}>{cond.label}</button>
                                    ))}
                                </div>
                                <button className="back-button" onClick={() => setScreen('home')} style={{marginTop: '20px'}}>‚Üê Back</button>
                                <button className="action-button" disabled={!condition} onClick={runAnalysis} style={{marginTop: '10px'}}>üîç Get My Answer</button>
                            </div>
                        </div>
                        {showAccount && <AccountModal onClose={() => setShowAccount(false)} />}
                        {showUpgrade && <UpgradeModal onClose={() => setShowUpgrade(false)} onShowEmailCapture={handleShowEmailCapture} />}
                    </>
                );
            }

            if (screen === 'result' && result) {
                return (
                    <>
                        <ScanCounter onClick={() => setShowAccount(true)} />
                        <div className="container">
                            <div className="result-card">
                                <div className="ai-badge">{result.analysisType === 'photo' ? 'üì∑ Photo Scan' : '‚ö° Quick Check'}</div>
                                <div className="result-icon">{result.recommendation === 'sell' ? 'üí∞' : '‚ù§Ô∏è'}</div>
                                <h2 className={`result-title ${result.recommendation}`}>{result.recommendation === 'sell' ? 'SELL IT!' : 'DONATE IT'}</h2>
                                <p className="result-reason">{result.reason}</p>

                                {result.effortScore && (
                                    <div className={`effort-score ${result.effortScore}`}>
                                        {result.effortScore === 'easy' ? '‚úÖ Easy to Sell' : result.effortScore === 'medium' ? '‚ö° Moderate Effort' : '‚ö†Ô∏è High Effort'}
                                    </div>
                                )}

                                {result.recommendation === 'sell' && (
                                    <div className="result-details">
                                        <div className="detail-row"><span className="detail-label">Estimated Price</span><span className="detail-value">${result.estimatedPrice}</span></div>
                                        <div className="detail-row"><span className="detail-label">Your Profit</span><span className="detail-value highlight">${result.netProfit}</span></div>
                                    </div>
                                )}

                                {result.marketData && (
                                    <div className="market-data">
                                        <div className="market-data-title">üí° Market Insight</div>
                                        <div className="market-data-content">{result.marketData}</div>
                                    </div>
                                )}

                                <button className="action-button" onClick={reset}>Scan Another Item</button>
                            </div>
                        </div>
                        {showAccount && <AccountModal onClose={() => setShowAccount(false)} />}
                    </>
                );
            }

            return null;
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
<!-- EXIT INTENT SURVEY - Paste this just before </body> in your index.html -->

<style>
  .exit-survey-backdrop {
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9998;
    opacity: 0;
    animation: exitFadeIn 0.2s ease-out forwards;
  }
  
  @keyframes exitFadeIn {
    to { opacity: 1; }
  }
  
  .exit-survey-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.95);
    background-color: #fff;
    border-radius: 12px;
    padding: 32px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    z-index: 9999;
    opacity: 0;
    animation: exitSlideUp 0.3s ease-out forwards;
  }
  
  @keyframes exitSlideUp {
    to { 
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
  }
  
  .exit-survey-close {
    position: absolute;
    top: 12px;
    right: 16px;
    background: none;
    border: none;
    font-size: 28px;
    color: #999;
    cursor: pointer;
    line-height: 1;
    padding: 4px;
  }
  
  .exit-survey-close:hover {
    color: #666;
  }
  
  .exit-survey-heading {
    margin: 0 0 8px 0;
    font-size: 20px;
    font-weight: 600;
    color: #1a1a1a;
  }
  
  .exit-survey-subheading {
    margin: 0 0 24px 0;
    font-size: 15px;
    color: #666;
  }
  
  .exit-survey-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 24px;
  }
  
  .exit-survey-option {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 12px 14px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    transition: all 0.15s ease;
    background-color: #fafafa;
  }
  
  .exit-survey-option:hover {
    border-color: #2563eb;
    background-color: #f0f7ff;
  }
  
  .exit-survey-option input {
    margin-right: 12px;
    width: 18px;
    height: 18px;
    accent-color: #2563eb;
  }
  
  .exit-survey-option span {
    font-size: 14px;
    color: #333;
  }
  
  .exit-survey-text-input {
    width: 100%;
    padding: 12px 14px;
    font-size: 14px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-top: 4px;
    box-sizing: border-box;
    outline: none;
  }
  
  .exit-survey-text-input:focus {
    border-color: #2563eb;
  }
  
  .exit-survey-submit {
    width: 100%;
    padding: 14px;
    font-size: 15px;
    font-weight: 600;
    color: #fff;
    background-color: #2563eb;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.15s ease;
  }
  
  .exit-survey-submit:hover {
    background-color: #1d4ed8;
  }
  
  .exit-survey-submit:disabled {
    background-color: #94a3b8;
    cursor: not-allowed;
  }
  
  .exit-survey-thankyou {
    text-align: center;
    padding: 20px 0;
  }
  
  .exit-survey-checkmark {
    display: inline-block;
    width: 48px;
    height: 48px;
    line-height: 48px;
    border-radius: 50%;
    background-color: #22c55e;
    color: #fff;
    font-size: 24px;
    margin-bottom: 12px;
  }
  
  .exit-survey-thankyou p {
    font-size: 16px;
    color: #333;
    margin: 0;
  }
  
  .exit-survey-hidden {
    display: none !important;
  }
</style>

<div id="exitSurveyBackdrop" class="exit-survey-backdrop exit-survey-hidden"></div>
<div id="exitSurveyModal" class="exit-survey-modal exit-survey-hidden">
  <button class="exit-survey-close" onclick="closeExitSurvey()">&times;</button>
  
  <div id="exitSurveyForm">
    <h2 class="exit-survey-heading">Quick question before you go</h2>
    <p class="exit-survey-subheading">What stopped you from trying a scan today?</p>
    
    <div class="exit-survey-options">
      <label class="exit-survey-option">
        <input type="radio" name="exitSurvey" value="I wasn't sure how it works">
        <span>I wasn't sure how it works</span>
      </label>
      
      <label class="exit-survey-option">
        <input type="radio" name="exitSurvey" value="I don't have an item nearby to try">
        <span>I don't have an item nearby to try</span>
      </label>
      
      <label class="exit-survey-option">
        <input type="radio" name="exitSurvey" value="I'm not sure I'd trust the value it gives">
        <span>I'm not sure I'd trust the value it gives</span>
      </label>
      
      <label class="exit-survey-option">
        <input type="radio" name="exitSurvey" value="I was just curious, not ready to use it yet">
        <span>I was just curious, not ready to use it yet</span>
      </label>
      
      <label class="exit-survey-option">
        <input type="radio" name="exitSurvey" value="other">
        <span>Something else</span>
      </label>
      
      <input type="text" id="exitSurveyOther" class="exit-survey-text-input exit-survey-hidden" placeholder="Tell us what's on your mind...">
    </div>
    
    <button class="exit-survey-submit" onclick="submitExitSurvey()" disabled>Submit</button>
  </div>
  
  <div id="exitSurveyThanks" class="exit-survey-thankyou exit-survey-hidden">
    <span class="exit-survey-checkmark">‚úì</span>
    <p>Thanks for your feedback!</p>
  </div>
</div>

<script>
(function() {
  var hasShown = sessionStorage.getItem('exitSurveyShown');
  
  if (!hasShown) {
    document.addEventListener('mouseleave', function(e) {
      if (e.clientY <= 0 && !sessionStorage.getItem('exitSurveyShown')) {
        showExitSurvey();
        sessionStorage.setItem('exitSurveyShown', 'true');
      }
    });
  }
  
  // Handle radio button changes
  document.querySelectorAll('input[name="exitSurvey"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
      var otherInput = document.getElementById('exitSurveyOther');
      var submitBtn = document.querySelector('.exit-survey-submit');
      
      if (this.value === 'other') {
        otherInput.classList.remove('exit-survey-hidden');
        otherInput.focus();
        submitBtn.disabled = otherInput.value.trim() === '';
      } else {
        otherInput.classList.add('exit-survey-hidden');
        submitBtn.disabled = false;
      }
    });
  });
  
  // Handle other text input
  document.getElementById('exitSurveyOther').addEventListener('input', function() {
    var selectedRadio = document.querySelector('input[name="exitSurvey"]:checked');
    if (selectedRadio && selectedRadio.value === 'other') {
      document.querySelector('.exit-survey-submit').disabled = this.value.trim() === '';
    }
  });
})();

function showExitSurvey() {
  document.getElementById('exitSurveyBackdrop').classList.remove('exit-survey-hidden');
  document.getElementById('exitSurveyModal').classList.remove('exit-survey-hidden');
}

function closeExitSurvey() {
  var selectedRadio = document.querySelector('input[name="exitSurvey"]:checked');
  if (!selectedRadio && typeof gtag !== 'undefined') {
    gtag('event', 'exit_survey_dismissed');
  }
  document.getElementById('exitSurveyBackdrop').classList.add('exit-survey-hidden');
  document.getElementById('exitSurveyModal').classList.add('exit-survey-hidden');
}

function submitExitSurvey() {
  var selectedRadio = document.querySelector('input[name="exitSurvey"]:checked');
  if (!selectedRadio) return;
  
  var response = selectedRadio.value;
  var otherText = '';
  
  if (response === 'other') {
    otherText = document.getElementById('exitSurveyOther').value.trim();
  }
  
  // Send to GA4
  if (typeof gtag !== 'undefined') {
    gtag('event', 'exit_survey_response', {
      response: response,
      other_text: otherText
    });
  }
  
  // Show thank you
  document.getElementById('exitSurveyForm').classList.add('exit-survey-hidden');
  document.getElementById('exitSurveyThanks').classList.remove('exit-survey-hidden');
  
  // Auto close after 2 seconds
  setTimeout(closeExitSurvey, 2000);
}

// Close on backdrop click
document.getElementById('exitSurveyBackdrop').addEventListener('click', closeExitSurvey);
</script>

<!-- END EXIT INTENT SURVEY -->

</body>
</html>
